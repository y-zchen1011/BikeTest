<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZQJGH8PK8W"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ZQJGH8PK8W');
    </script>
    <meta charset="UTF-8">
    <title>Result</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="Plugin_bootstrap/css/bootstrap.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@1,300&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="Plugin_fontawesome/css/all.css" rel="stylesheet">
    <link href="CSS/main.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/jquery-3.5.0.js"></script>

    <style>
        .loader{
            height: 40px;
            width: 40px;
            text-align: center;
            display: inline-block;
            vertical-align: top;
        }
        svg path,
        svg rect{
            fill: #FFFFFF;
        }
    </style>
</head>

<body>

<header class="bg-dark py-1">
    <div class="container">
        <h1 class="logo"><a href="https://cieeberlin.org">CIEE</a></h1>
    </div>
</header>

<section id="success" class="container mx-auto text-center">
    <h1 id="msg_title" class="mt-5 text-primary"></h1>
    <h2 class="my-3">Your score : <span class="ipscore my-3 text-danger" id="resultsc"></span></h2>
    <p id="msg_content" class="mt-3"></p>
    <div class="text-right mr-5">
        <input id="startAgain" class="btn-lg btn_startAgain btn-primary rounded-lg text-white py-2 px-4 mr-5"
               type="button"
               name="submit" value="Start again">
    </div>
</section>

<section id="answerReview" class="container bg-light mx-auto text-center ">
    <div class="d-flex justify-content-around align-items-center">
        <h3 class="">Review</h3>
        <button class="btn btn-primary" id="expand">Expand/Collapse</button>
    </div>
    <div id="wrapper" class="open bg-light table-responsive">
        <table id="testReview" class="table">
            <thead>
                <tr>
                    <th scope="col">1</th>
                    <th scope="col">2</th>
                    <th scope="col">3</th>
                    <th scope="col">4</th>
                    <th scope="col">5</th>
                    <th scope="col">6</th>
                    <th scope="col">7</th>
                    <th scope="col">8</th>
                    <th scope="col">9</th>
                    <th scope="col">10</th>
                    <th scope="col">11</th>
                    <th scope="col">12</th>
                </tr>
            </thead>
            <tbody>
                <tr id="reviewTable">
                </tr>
            </tbody>
        </table>
    </div>
</section>

<section id="registerForm" class="mt-5 bg-light">
    <div class="container">
        <div class="Regis_holder">
            <h1 class="text-center mx-auto mb-3 pl-2 pt-2">Registration</h1>
            <form>
                <div class="form-row align-items-center mx-auto">
                    <div class="col-md-8 mx-auto mb-2">
                        <label class="sr-only" for="inlineFormInputfirstName">Username</label>
                        <div class="input-group mb-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">First name</div>
                            </div>
                            <input type="text" class="form-control" id="inlineFormInputfirstName" required>
                        </div>
                    </div>
                    <div class="col-md-8 mx-auto mb-2">
                        <label class="sr-only" for="inlineFormInputlastName">Username</label>
                        <div class="input-group mb-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">Last name</div>
                            </div>
                            <input type="text" class="form-control" id="inlineFormInputlastName" required>
                        </div>
                    </div>
                    <div class="col-md-8 mx-auto mb-2">
                        <div class="input-group mb-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">Email</div>
                            </div>
                            <input type="email" class="form-control" id="inlineFormInputemail" required>
                        </div>
                    </div>
                    <div class="col-md-8 mx-auto mb-2">
                        <label class="sr-only" for="inlineFormInputroomnr">Username</label>
                        <div class="input-group mb-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">Room number</div>
                            </div>
                            <input type="text" class="form-control" id="inlineFormInputroomnr" required>
                        </div>
                    </div>
                    <div class="col-md-8 mx-auto mb-2">
                        <label class="mr-sm-2 sr-only" for="inlineFormCustomSelect">Preference</label>
                        <select class="custom-select mr-sm-2" id="inlineFormCustomSelect">
                            <option selected disabled>Your Stay</option>
                            <option value="1">Till end of Block I</option>
                            <option value="2">Till end of Block II</option>
                            <option value="3">Till end of Block III</option>
                        </select>
                    </div>

                    <div class="col-md-8 form-group mx-auto">
                        <div class="form-check  mt-4 text-justify">
                            <input class="form-check-input " type="radio" name="qa1" id="gridRadios1" value="option1"
                                   checked>
                            <label class="form-check-label font-weight-bolder ml-2" for="gridRadios1">
                                I have entered a valid email address which I can always receive mails from Student Life
                                Office while checking-in/out a bike.
                                <br>
                                <p class="mt-2">I agree to the terms and conditions<span
                                        style="color: red;vertical-align: top">*</span></p>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-8 form-group mx-auto">
                        <div class="form-check   mt-4 text-justify">
                            <input class="form-check-input" type="radio" name="qa2" id="gridRadios2" value="option2"
                                   checked>
                            <label class="form-check-label font-weight-bolder ml-2" for="gridRadios2">
                                I agree that I would notify the Student Life Office by email or in-person if not getting
                                a confirmation E-mail within 24 hours (except for weekends) once I successfully
                                check-in/out a bike.
                                <br>
                                <p class="mt-2">I agree to the terms and conditions<span
                                        style="color: red;vertical-align: top">*</span></p>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-8 form-group mx-auto">
                        <div class="form-check   mt-4 text-justify">
                            <input class="form-check-input" type="radio" name="qa3" id="gridRadios3" value="option3"
                                   checked>
                            <label class="form-check-label font-weight-bolder ml-2" for="gridRadios3">
                                I acknowledge that it is my responsibility to reach out to the Student Life Office if a
                                rental confirmation email was sent to my own email by any mistake since the rental would
                                be under my name.
                                <br>
                                <p class="mt-2">I agree to the terms and conditions<span
                                        style="color: #ff0000;vertical-align: top">*</span></p>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-8 my-4 mx-auto d-flex justify-content-end">
                        <button type="submit" class="btn btn_formSubmit btn-lg btn-primary mb-2 px-5" id="formSubmit">Submit
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<footer class="bg-dark">
    <div class="container d-flex justify-content-center flex-column align-items-center">
        <p class="text-white pt-4">If you need any support</p>
        <p class="text-white">Email : <a href="mailto:YChen@ciee.org" class="text-white">YChen@ciee.org</a>
        </p>
        <p class="text-white">or just come by the reception</p>
    </div>
</footer>






</body>


<script src="js/form.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js">
</script>

<script>

    let config = {
        apiKey: "AIzaSyBgNHmBw53QL51_4J-JP54PyWEF7fR-NUk",
        authDomain: "https://cieebikeservice.firebaseio.com/",
        databaseURL: "https://cieebikeservice.firebaseio.com/",
        storageBucket: "cieebikeservice.appspot.com",
        projectId: "cieebikeservice",
    };
    firebase.initializeApp(config);
    var msgRef = firebase.database();

    $(function() {
        var b = $("#expand");
        var w = $("#wrapper");
        var l = $("#testReview");

        w.height(l.outerHeight(true));

        b.click(function(e) {
            e.preventDefault();
            if(w.hasClass('open')) {
                w.removeClass('open');
                w.height(0);
            } else {
                w.addClass('open');
                w.height(l.outerHeight(true));
            }

        });
    });
</script>


<script>
    (function () {
        emailjs.init("user_bLcS7SbZdTLTMgGDlu4HP");
    })();
</script>

<script>
    const formSubmit = document.querySelector('#formSubmit');
    formSubmit.addEventListener('click', function (e) {
        formSubmit.setAttribute('disabled',"");
        formSubmit.innerHTML = '<div class="loader loader--style1" title="0">\n' +
            '    <svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\n' +
            '         width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">\n' +
            '  <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946\n' +
            '    s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634\n' +
            '    c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"/>\n' +
            '        <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0\n' +
            '    C22.32,8.481,24.301,9.057,26.013,10.047z">\n' +
            '    <animateTransform attributeType="xml"\n' +
            '                      attributeName="transform"\n' +
            '                      type="rotate"\n' +
            '                      from="0 20 20"\n' +
            '                      to="360 20 20"\n' +
            '                      dur="0.5s"\n' +
            '                      repeatCount="indefinite"/>\n' +
            '    </path>\n' +
            '  </svg>\n' +
            '</div>';
        let firstName = document.querySelector('#inlineFormInputfirstName').value.trim();
        let lastName = document.querySelector('#inlineFormInputlastName').value.trim();
        let roomNr = document.querySelector('#inlineFormInputroomnr').value.trim();
        let email = document.querySelector('#inlineFormInputemail').value.trim();
        let stay = document.querySelector('#inlineFormCustomSelect').value;
        let q1 = document.querySelector('#gridRadios1').value;
        let q2 = document.querySelector('#gridRadios2').value;
        let q3 = document.querySelector('#gridRadios3').value;
        e.preventDefault();
        if (firstName === "" || lastName === "" || roomNr === "" || email === "" ||
            stay === "Your Stay" || q1 === "" || q2 === "" || q3 === "") {
            formSubmit.removeAttribute('disabled');
            formSubmit.innerHTML = "Submit";
            alert('Please fill in all fields');
        } else {
            firstName = initCapital(firstName);
            lastName = initCapital(lastName);
            if (ValidateEmail(email)) {
                axios.post("https://cieebikeapi.herokuapp.com/api/member",{
                    firstname: firstName,
                    lastname: lastName,
                    roomnumber: roomNr,
                    emailaddress: email,
                    stay: stay,
                }).catch((err)=>{
                    console.log("Error, Using Back-up Server ", err);
                    msgRef.ref('/Member/'+firstName+'_'+lastName).set({
                        firstname: firstName,
                        lastname : lastName,
                        roomnumber: roomNr,
                        emailaddress: email,
                        stay:stay,
                        hasbike :false,
                    }).then(()=>{
                        msgRef.ref('/Member/').once('child_added',function (){
                            console.log('Back up Server updated success')
                        })
                    });
                }).then(()=>{
                    let templateParams = {
                        title: 'Welcome letter',
                        msg: 'You can now go to the reception and rent out your bike!',
                        Name: firstName,
                        mailadress: email
                    };
                    emailjs.send('service_3dk0adg', 'template_k6y7q2b', templateParams)
                            .then((response)=>{
                                console.log("Using Primary Email Server");
                                console.log('SUCCESS!', response.status, response.text);
                            })
                            .then(()=>{
                                formSubmit.innerHTML = "Submit";
                                alert('Registration success!');
                                window.location.href = 'EndPage.html';
                            })
                            .catch((err)=>{
                                console.log('FAILED... ', err);
                                console.log('Using back-up Email Server...');
                                axios.post("https://cieemail.herokuapp.com/send/info", templateParams)
                                    .then((res)=>{
                                        console.log('Using back-up Email Server is successful');
                                        console.log(res.config.data);
                                    })
                                    .then(()=>{
                                        formSubmit.innerHTML = "Submit";
                                        alert('Registration success!');
                                        window.location.href = 'EndPage.html';
                                    })
                                    .catch((err)=>{
                                        formSubmit.innerHTML = "Submit";
                                        console.log("Both Email Servers are down. ", err);
                                        alert("Sorry, Our Email Server are down. You won't get a Email but your registration was successful!")
                                    })
                            })
                }).catch(function () {
                    formSubmit.removeAttribute('disabled');
                    formSubmit.innerHTML = "Submit";
                    alert('Error, please try again');
                });
            } else {
                console.log("here");
                formSubmit.removeAttribute('disabled');
                formSubmit.innerHTML = "Submit";
                alert("You have entered an invalid email address!");
            }
        }
    }, false);

    function initCapital(str) {
        var strarr = str.split(' ');
        var result = '';
        for (var i in strarr) {
            result = strarr[i].substring(0, 1).toUpperCase() + strarr[i].substring(1);
        }
        return result;
    }

    function ValidateEmail(email) {
        if (/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/.test(email)) {
            return (true);
        }
    }


</script>


</html>
